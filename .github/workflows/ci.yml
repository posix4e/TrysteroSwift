name: CI

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main ]

jobs:
  test:
    runs-on: macos-latest
    
    steps:
    - name: Checkout
      uses: actions/checkout@v4
      
    - name: Setup Xcode
      uses: maxim-lobanov/setup-xcode@v1
      with:
        xcode-version: latest-stable
        
    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '21'
        
    - name: Install Dependencies
      run: |
        brew install swiftlint
        cd Tests/Interop && npm install
        
    - name: Lint Swift Code
      run: swiftlint lint --strict
      
    - name: Lint JavaScript Code
      working-directory: Tests/Interop
      run: npm run lint
      
    - name: Build
      run: swift build
      
    - name: Unit Tests
      run: swift test --filter IntegrationTest.testRoomLifecycle
      
    - name: Interoperability Tests
      run: |
        export INTEROP_ROOM_ID="ci-test-$(date +%s)"
        export EXPECT_JS_PEER="true"
        
        # Start local test relay
        cd Tests/Interop
        node test-relay.js 2>&1 | sed 's/^/[RELAY] /' &
        RELAY_PID=$!
        sleep 1
        
        # Use local relay for tests (supports comma-separated list)
        export TEST_RELAY_URL="ws://localhost:7777"
        
        # Start JavaScript peer in background with output
        node test.js 2>&1 | sed 's/^/[JS] /' &
        JS_PID=$!
        cd ../..
        
        # Give JS peer time to start
        sleep 2
        
        # Run Swift test
        swift test --filter IntegrationTest.testJavaScriptInterop
        SWIFT_RESULT=$?
        
        # Clean up
        kill $JS_PID 2>/dev/null || true
        kill $RELAY_PID 2>/dev/null || true
        
        if [ $SWIFT_RESULT -eq 0 ]; then
          echo "✅ Interoperability test passed!"
        else
          echo "❌ Interoperability test failed"
          exit 1
        fi