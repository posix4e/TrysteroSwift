name: CI

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main ]

jobs:
  build-test-deploy:
    runs-on: macos-latest
    steps:
    - name: Checkout
      uses: actions/checkout@v4
      
    - name: Setup Xcode
      uses: maxim-lobanov/setup-xcode@v1
      with:
        xcode-version: latest-stable

    - name: Install SwiftLint
      run: brew install swiftlint
        
    - name: Cache Swift packages
      uses: actions/cache@v4
      with:
        path: .build
        key: ${{ runner.os }}-spm-${{ hashFiles('Package.swift') }}
        restore-keys: |
          ${{ runner.os }}-spm-
          
    - name: Lint
      run: swiftlint lint --strict

      
    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '20'
        cache: 'npm'
        cache-dependency-path: Tests/Interop/package.json
          
    - name: Run interop test
      id: interop
      working-directory: Tests/Interop
      run: |
        npm install
        echo "ğŸ§ª Testing Trystero.js â†” TrysteroSwift Interoperability..."
        
        # First verify both implementations use the same protocol values
        echo "ğŸ” Verifying protocol compatibility..."
        node -e "
        import {joinRoom} from 'trystero';
        const config = {appId: 'trystero', relays: []};
        console.log('Node.js using appId: trystero, roomId: swift-interop-test');
        "
        
        cd ../.. && swift -e '
        import Foundation
        import CryptoKit
        let appId = "trystero"
        let roomId = "swift-interop-test"
        let topicPath = "Trystero@\(appId)@\(roomId)"
        let data = Data(topicPath.utf8)
        let digest = Insecure.SHA1.hash(data: data)
        let hash = digest.map { String($0, radix: 36) }.joined()
        let truncated = String(hash.prefix(20))
        func strToNum(_ s: String, mod: Int) -> Int { var sum = 0; for c in s { sum += Int(c.asciiValue ?? 0) }; return sum % mod }
        let kind = 20000 + strToNum(hash, mod: 10000)
        print("Swift generating: kind=\(kind), tag=[\"x\", \"\(truncated)\"]")
        '
        cd Tests/Interop
        
        # Start Node.js harness in background
        echo "ğŸš€ Starting Node.js Trystero harness..."
        node trystero-node.js &
        NODE_PID=$!
        
        # Give Node.js time to connect to relays
        sleep 8
        
        # Check if Node.js process is still running
        if ! kill -0 $NODE_PID 2>/dev/null; then
          echo "âŒ Node.js harness failed to start or crashed"
          echo "ğŸ” Check the Node.js logs above for specific errors"
          exit 1
        fi
        echo "âœ… Node.js harness is running (PID: $NODE_PID)"
        
        # Run Swift interoperability test with timeout
        echo "ğŸ§ª Running Swift interoperability test..."
        cd ../..
        
        # Run Swift test with timeout using Perl alarm
        perl -e 'alarm shift; exec @ARGV' 45 swift test --filter testTrysteroJSInteroperability || {
          EXIT_CODE=$?
          
          if [ $EXIT_CODE -eq 142 ]; then
            echo "âŒ TIMEOUT: Swift test reached 45 second timeout"
            echo "âš ï¸  This could indicate:"
            echo "   - Slow relay connectivity"  
            echo "   - Peer discovery issues"
            echo "   - WebRTC signaling problems"
            FINAL_RESULT=1
          elif [ $EXIT_CODE -ne 0 ]; then
            echo "âŒ FAILED: Swift test failed (exit code: $EXIT_CODE)"
            echo "ğŸ” This indicates real interoperability issues"
            FINAL_RESULT=1
          else
            echo "âœ… Swift test completed successfully"
            FINAL_RESULT=0
          fi
        }
        
        # Clean up Node.js process
        cd Tests/Interop
        if kill -0 $NODE_PID 2>/dev/null; then
          kill $NODE_PID 2>/dev/null || true
          wait $NODE_PID 2>/dev/null || true
        fi
        
        # Final result
        if [ "${FINAL_RESULT:-0}" -eq 0 ]; then
          echo "âœ… Interoperability test completed successfully"
          echo "ğŸ‰ TrysteroSwift successfully communicates with Trystero.js!"
        else
          echo "âŒ Interoperability test failed"
          echo "ğŸ” TrysteroSwift cannot properly communicate with Trystero.js"
          exit 1
        fi
        
    - name: Interop Test Summary
      if: always()
      run: |
        echo "ğŸ“Š === INTEROPERABILITY TEST SUMMARY ==="
        if [ "${{ steps.interop.outcome }}" == "success" ]; then
          echo "âœ… Status: PASSED - TrysteroSwift is compatible with Trystero.js"
          echo "ğŸ¯ This confirms cross-platform peer-to-peer communication works"
          echo "ğŸš€ TrysteroSwift is ready for production use!"
        else
          echo "âŒ Status: FAILED - TrysteroSwift cannot communicate with Trystero.js"
          echo "ğŸš¨ This is a CRITICAL FAILURE - the library is broken"
          echo "ğŸ” This indicates problems with:"
          echo "   - Nostr protocol implementation"
          echo "   - WebRTC signaling compatibility" 
          echo "   - Network connectivity"
          echo "   - Timing issues"
          echo ""
          echo "ğŸ› ï¸  To debug locally: cd Tests/Interop && npm install && node trystero-node.js"
          echo "âš ï¸  The build will fail because interoperability is mandatory"
        fi
